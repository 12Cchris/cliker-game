<!doctype html>


try{
const dbRef = ref(db);
const snap = await get(child(dbRef, 'admin/password'));
if (!snap.exists()) { alert('관리자 비밀번호가 설정되어 있지 않습니다. Firebase 콘솔에서 admin/password를 추가하세요.'); return; }
const correct = snap.val();
if (input === correct){
// 로그인 성공
passwordInput.value = '';
loginBtn.style.display = 'none'; logoutBtn.style.display = 'inline-block';
tbl.style.display = 'table';
startRealtime();
} else {
alert('비밀번호가 틀렸습니다.');
}
}catch(e){
console.error(e);
alert('비밀번호 확인 중 오류가 발생했습니다. 콘솔을 확인하세요.');
}
});


logoutBtn.addEventListener('click', ()=>{
// 단순 UI 로그아웃
if (liveUnsub) { liveUnsub(); liveUnsub = null; }
tbody.innerHTML = '';
tbl.style.display = 'none';
loginBtn.style.display = 'inline-block'; logoutBtn.style.display = 'none';
});


function startRealtime(){
const playsRef = ref(db, 'plays');
// onValue을 통해 실시간 구독
liveUnsub = onValue(playsRef, (snapshot)=>{
const data = snapshot.val();
tbody.innerHTML = '';
if (!data){
tbody.innerHTML = '<tr><td colspan="4">아직 참가자가 없습니다.</td></tr>';
return;
}
// data는 객체(자동키: item)
// 역순으로(최신 위로) 정렬하려면 키들을 시간으로 정렬
const items = Object.values(data).sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
for (const item of items){
const tr = document.createElement('tr');
const ts = item.timestamp ? new Date(item.timestamp).toLocaleString() : '-';
const duration = item.durationMs ? `${Math.floor(item.durationMs/1000)}초` : '-';
tr.innerHTML = `
<td>${escapeHtml(item.nickname||'무명')}</td>
<td>${item.clicks ?? '-'}</td>
<td>${duration}</td>
<td>${ts}</td>
`;
tbody.appendChild(tr);
}
});
}


function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
</script>
</body>
</html>